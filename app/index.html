<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Waresys · Light</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: {} } };</script>
    <style>html,body{height:100%} /* ==== local chart tooltips (pie/weekly) ==== */
.chart-tip{
  position:fixed; padding:6px 10px; border-radius:8px;
  background:rgba(15,23,42,.96); color:#e5e7eb;
  font:12px system-ui; pointer-events:none; transform:translate(-50%,-120%);
  box-shadow:0 8px 24px rgba(0,0,0,.35); border:1px solid rgba(148,163,184,.25);
  display:none; z-index:50;
}
</style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- React + ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Recharts (versioned) + fallback -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js" crossorigin></script>
    <script>
      if (!window.Recharts) {
        document.write('<script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"><\/script>');
      }
    </script>

    <!-- Babel for inline JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- One-time API base locker -->
    <script>
      (async function lockApiBase() {
        const KEY = "WARESYS_API";
        const LOCK = "WARESYS_API_LOCKED";
        if (sessionStorage.getItem(LOCK) === "2") return;

        const stored = (localStorage.getItem(KEY) || "").replace(/\/+$/, "");
        const probes = stored ? [stored] : [window.location.origin, "http://localhost:8000"];

        for (const base of probes) {
          try {
            const u = base.replace(/\/+$/, "") + "/api/health";
            const r = await fetch(u, { mode: "cors", cache: "no-store" });
            if (r.ok) {
              if (stored !== base) {
                localStorage.setItem(KEY, base.replace(/\/+$/, ""));
                if (!sessionStorage.getItem(LOCK)) {
                  sessionStorage.setItem(LOCK, "1");
                  location.reload(); // one-time bind to API
                  return;
                }
              }
              sessionStorage.setItem(LOCK, "2");
              return;
            }
          } catch {}
        }
        if (!stored) localStorage.setItem(KEY, "http://localhost:8000");
        sessionStorage.setItem(LOCK, "2");
      })();
    </script>

    <script type="text/babel">
      // ---------------- libs & React hooks
      const R = window.Recharts || {};
const {
  ResponsiveContainer,
  ComposedChart, BarChart, Bar, LineChart, Line,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ReferenceLine,
  PieChart, Pie, Cell, Sector
} = R;
const HAS_R = !!(window.Recharts && window.Recharts.PieChart);

      const { useEffect, useMemo, useRef, useState } = React;

      // ---------------- small helpers
      const fmtDate = d => { try { return d ? new Date(d).toLocaleDateString() : "—"; } catch { return "—"; } };
      const fmtINR  = v => v==null ? "—" : "₹" + Number(v).toLocaleString("en-IN");

  function useVisibleSize() {
    const ref = React.useRef(null);
    const [state, setState] = React.useState({ w: 0, h: 0, visible: true });

    React.useEffect(() => {
      const el = ref.current;
      if (!el) return;

      const ro = new ResizeObserver((entries) => {
        for (const e of entries) {
          const cr = e.contentRect;
          setState((s) => ({ ...s, w: cr.width, h: cr.height || s.h }));
        }
      });
      ro.observe(el);

      const io = new IntersectionObserver(
        ([e]) => setState((s) => ({ ...s, visible: e.isIntersecting })),
        { threshold: 0.01 }
      );
      io.observe(el);

      return () => {
        ro.disconnect();
        io.disconnect();
      };
    }, []);

    return [ref, state];
  }

      /* ===== HSN→Category config (ONLY these HSNs count) ===== */
const HSN_GROUPS = {
  "Tiles": ["690721","690722"],
  "Sanitaryware (Ceramic)": ["691010"],
  "Metal Fixtures & Fittings": ["848180","848190","732410","7418"],
  "Connectors & Fasteners": ["391710","391740","392290","731815","7318","741220"],
  "Mirrors & Glass": ["700910"],
  "Adhesives, Chemicals & Tapes": ["382450","392099"]
};
// ignore services (e.g., 9964 transport)
const SAC_EXCLUDE_PREFIX = "99";

/* returns {category, hsn} if HSN is in our groups; otherwise null (ignored) */
function categorizeHSN(rawHSN) {
  if (!rawHSN) return null;
  const hsn = String(rawHSN).replace(/\D/g,'');           // keep only digits
  if (!hsn || hsn.startsWith(SAC_EXCLUDE_PREFIX)) return null;
  for (const [cat, list] of Object.entries(HSN_GROUPS)) {
    if (list.includes(hsn)) return { category: cat, hsn };
    if (list.some(x => x.length===4 && hsn.startsWith(x))) return { category: cat, hsn };
  }
  return null;
}

      // parse numeric text like "₹1,234.50" → 1234.50
      const num = (v) => {
        if (v === null || v === undefined) return 0;
        const s = String(v).replace(/[^\d.\-]/g, '');
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      };

        // lines to EXCLUDE from pre-GST subtotal
        const isTaxOrRoundingLine = (desc = "") =>
          /(^|\s)(cgst|sgst|igst|vat|tax|round[\s-]*off|rounding|r\/?o|tcs|tds|cess)(\s|$)/i.test(desc);

      // demo fallbacks (only if API isn’t reachable)
      const demoBills = () => ([
        { id: 101, bill_no: "A2Z/INV/8731", bill_date: new Date().toISOString(), party_name: "—", lines: new Array(12), status: "PROCESSED", accuracy: 93 },
        { id: 102, bill_no: "KJ/PI/554",   bill_date: new Date(Date.now()-864e5).toISOString(), party_name: "—", lines: new Array(9), status: "PROCESSED", accuracy: 92 },
        { id: 103, bill_no: "RET/DEL/901", bill_date: new Date(Date.now()-2*864e5).toISOString(), party_name: "—", lines: new Array(7), status: "ERROR", accuracy: 0 },
      ]);
      const demoProducts = () => ([
        { sku:"TIL-001", name:"Matte Tile 12x12", category:"Tiles",    hsn:"6907", price:450,  stock_qty:120, reorder_point:30 },
        { sku:"PIP-110", name:"PVC Pipe 110mm",   category:"Pipes",    hsn:"3917", price:260,  stock_qty:80,  reorder_point:20 },
        { sku:"FIT-AAA", name:"Coupling AAA",     category:"Fittings", hsn:"8481", price:95,   stock_qty:300, reorder_point:100 },
        { sku:"WC-001",  name:"Wall Closet",      category:"WC",       hsn:"6910", price:4200, stock_qty:22,  reorder_point:5  },
      ]);

      // ---------------- strict mapping to server shape (NO dedupe)
      function mapServerBill(raw = {}) {
        const lines = (raw.lines || []).map((l, i) => {
          const qty   = Number(l.qty ?? 0);
          const rate  = Number(l.unit_price ?? l.rate ?? 0);
          const amt   = Number(l.line_total ?? l.amount ?? (qty * rate));
          return {
            idx: i + 1,
            description: (l.description_raw || l.description || "—"),
            hsn: (l.hsn || "—"),
            uom: (l.uom || "—"),
            qty, rate, amount: amt,
          };
        });

        // 1) Server-provided total (fallback: sum of amounts)
        const total =
          (typeof raw.total === "number")
            ? raw.total
            : lines.reduce((s, ln) => s + (num(ln.amount) || 0), 0);

        // 2) Client-side pre-GST subtotal: sum only product lines (skip tax/round-off/cess)
        const pre_total = lines.reduce((s, ln) => {
          const d = (ln.description || "").trim();
          if (isTaxOrRoundingLine(d)) return s;             // exclude CGST/SGST/IGST/VAT/Tax/RO/Cess/TCS/TDS
          const amt = num(ln.amount) || (num(ln.qty) * num(ln.rate));
          return s + (isFinite(amt) ? amt : 0);
        }, 0);


        return {
  bill_id: raw.bill_id ?? raw.id,
  bill_no: raw.bill_no ?? raw.number ?? raw.invoice_no ?? raw.filename ?? "—",
  bill_date: raw.bill_date ?? raw.date ?? null,
  party_name: raw.party_name || "—",
  gstin: raw.gstin || raw.vendor?.gst_number || raw.vendor_gst || "—",
  status: raw.status || "PROCESSED",
  lines,
  total,
  pre_total,     // ← added
  line_count: Array.isArray(raw.lines) ? raw.lines.length : (raw.line_count ?? 0),
};

      }
      /* Build category & weekly aggregates from a list of bills (server shape or mapServerBill shape) */
function buildCategoryAggregates(bills) {
  
  const pieCounts = {};     // { category: totalQty }
  const catHsn = {};        // { "category::hsn": {category, hsn, qty} }
  const weekly = {};        // { "YYYY-Www": qty }

  const toWeek = (iso) => {
    if (!iso) return null;
    const d = new Date(iso + 'T00:00:00'); if (isNaN(d)) return null;
    const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = dt.getUTCDay() || 7;
    dt.setUTCDate(dt.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((dt - yearStart) / 86400000) + 1) / 7);
    return `${dt.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
  };

  (bills || []).forEach(b => {
    const wk = toWeek(b.bill_date);
    (b.lines || []).forEach(ln => {
      const tag = categorizeHSN(ln.hsn);
      if (!tag) return; // not in our groups → ignore
      const q = Number(ln.qty) || 1;

      pieCounts[tag.category] = (pieCounts[tag.category] || 0) + q;
      const key = `${tag.category}::${tag.hsn}`;
      if (!catHsn[key]) catHsn[key] = { category: tag.category, hsn: tag.hsn, qty: 0 };
      catHsn[key].qty += q;
      if (wk) weekly[wk] = (weekly[wk] || 0) + q;
    });
  });

  const pieData = Object.entries(pieCounts).map(([category, qty]) => ({ category, qty }));
  const tableData = Object.values(catHsn).sort((a,b)=> a.category.localeCompare(b.category) || a.hsn.localeCompare(b.hsn));
  const weeklyData = Object.keys(weekly).sort().map(k => ({ week: k, qty: weekly[k] }));
  return { pieData, tableData, weeklyData };
}
// Reorder point per category (tune as you like)
const REORDER_BY_CATEGORY = {
  "Tiles": 50,
  "Sanitaryware (Ceramic)": 10,
  "Metal Fixtures & Fittings": 30,
  "Connectors & Fasteners": 200,
  "Mirrors & Glass": 15,
  "Adhesives, Chemicals & Tapes": 80
};

// Collapse invoice lines into "products" for Stock table
// Collapse invoice lines into "products" for Stock table
function buildProductsFromBills(bills) {
  const map = new Map(); // key = "desc|hsn"
  (bills || []).forEach(b => (b.lines || []).forEach(ln => {
    const tag = categorizeHSN(ln.hsn);
    if (!tag) return; // ignore non-group HSNs
    const name = (ln.description_raw || ln.description || '').trim() || '(no name)';
    const key = name + '|' + tag.hsn;
    const qty = Number(ln.qty) || 1;
    const price = Number(ln.unit_price ?? ln.rate) || 0;

    if (!map.has(key)) {
      // create a harmless sku so any existing sort/key on sku won't explode
      const sku = (tag.hsn + '-' + name.toLowerCase().replace(/[^a-z0-9]+/g,'-')).slice(0,30);
      map.set(key, { sku, name, category: tag.category, hsn: tag.hsn, price, stock_qty: qty });
    } else {
      const o = map.get(key);
      o.stock_qty += qty;
      if (price > 0) o.price = o.price > 0 ? ((o.price + price) / 2) : price; // simple avg
    }
  }));
  return Array.from(map.values()).map(p => ({ ...p, reorder_point: REORDER_BY_CATEGORY[p.category] ?? 20 }));
}
// ---- Category stock aggregation + simple icons ----
function aggregateCategoryStock(products = []) {
  const acc = {};
  for (const p of products) {
    const cat = (p.category || "Uncategorized").trim();
    const qty = Number(p.stock_qty ?? p.qty ?? 0);
    const rop = Number(p.reorder_point ?? REORDER_BY_CATEGORY[cat] ?? 20);
    if (!acc[cat]) acc[cat] = { category: cat, stock: 0, reorder: rop };
    acc[cat].stock += qty;
    acc[cat].reorder = Math.max(acc[cat].reorder, rop);
  }
  return Object.values(acc).sort((a,b)=>a.category.localeCompare(b.category));
}

function iconForCategory(name="") {
  const n = (name || "").toLowerCase();
  // Primary mappings for your current categories
  if (n.includes("tile")) return "🧱";                                      // Tiles
  if (n.includes("sanit") || n.includes("ceramic")) return "🚿";            // Sanitaryware (Ceramic)
  if (n.includes("mirror") || n.includes("glass")) return "🪞";             // Mirrors & Glass
  if (n.includes("fixture") || n.includes("fitting") || n.includes("metal")) return "🔩"; // Metal Fixtures & Fittings
  if (n.includes("connect") || n.includes("fasten") || n.includes("screw") || n.includes("bolt")) return "🪛"; // Connectors & Fasteners
  if (n.includes("adhes") || n.includes("chemical") || n.includes("tape") || n.includes("sealant") || n.includes("glue")) return "🧪"; // Adhesives, Chemicals & Tapes

  // Secondary/common fallbacks
  if (n.includes("faucet") || n.includes("tap")) return "🚰";
  if (n.includes("plumb")) return "🪠";
  if (n.includes("elect")) return "🔌";
  if (n.includes("granite") || n.includes("marble") || n.includes("stone")) return "🪨";
  return "📦";
}




/* simple palette */
const PAL = (i) => `hsl(${(i*57)%360} 70% 55%)`;


let __pieSlices = []; // [{s,e,category,qty,color}]
function renderPie(data) {
  const cvs = document.getElementById('pieCanvas'); if (!cvs) return;
  const tip = document.getElementById('chartTip');

  const ctx = cvs.getContext('2d');

  // --- set canvas to its *displayed* size (handles DPR + responsive width) ---
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = cvs.getBoundingClientRect();
  const cssW = Math.max(10, rect.width);
  const cssH = Math.max(10, rect.height);
  cvs.width  = Math.round(cssW * dpr);
  cvs.height = Math.round(cssH * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);      // draw in CSS pixels
  ctx.clearRect(0, 0, cssW, cssH);

  // --- donut geometry ---
  const BASE = -Math.PI / 2;                   // 12 o'clock as 0°
  const cx = cssW / 2;
  const cy = cssH / 2;
  const R  = Math.min(cssW, cssH) * 0.48;      // outer radius (bigger)      // outer radius
  const r  = R * 0.62;                          // inner radius

  // --- build slices with angles relative to BASE ---
  const total = Math.max(1, data.reduce((s, d) => s + (Number(d.qty) || 0), 0));
  __pieSlices = [];
  let a0 = BASE;
  data.forEach((d, i) => {
    const val = Number(d.qty) || 0;
    const a   = (val / total) * Math.PI * 2;
    const a1  = a0 + a;
    const color = `hsl(${(i * 70) % 360} 85% 60%)`;
    __pieSlices.push({ s: a0, e: a1, category: d.category, qty: val, color });
    a0 = a1;
  });

  // --- draw all slices once ---
  draw(); // initial render

  // --- hover interaction (correctly mapped to CSS pixels) ---
  cvs.onmousemove = (evt) => {
    const r2 = cvs.getBoundingClientRect();                 // fresh rect in case of resize
    const x = evt.clientX - r2.left;
    const y = evt.clientY - r2.top;
    const dx = x - cx, dy = y - cy;
    const rr = Math.hypot(dx, dy);

    // outside the ring
    if (rr < r || rr > R) { tip.style.display = 'none'; cvs.style.cursor = 'default'; draw(-1); return; }

    // angle from BASE (12 o'clock), in [BASE, BASE+2π)
    let ang = Math.atan2(dy, dx);                // (-π, π]
    while (ang < BASE) ang += Math.PI * 2;       // shift up to BASE
    // find hit slice
    let hit = -1;
    for (let i = 0; i < __pieSlices.length; i++) {
      const sl = __pieSlices[i];
      if (ang >= sl.s && ang <= sl.e) { hit = i; break; }
    }
    if (hit === -1) { tip.style.display = 'none'; cvs.style.cursor = 'default'; draw(-1); return; }

    const s = __pieSlices[hit];
    tip.textContent = `${s.category} — ${Math.round(s.qty)}`;
    tip.style.left = `${evt.clientX}px`;
    tip.style.top  = `${evt.clientY}px`;
    tip.style.display = 'block';
    cvs.style.cursor = 'pointer';
    draw(hit);
  };
  cvs.onmouseleave = () => { tip.style.display = 'none'; cvs.style.cursor = 'default'; draw(-1); };

  // --- redraw with optional highlighted slice (floats out by a few px) ---
  function draw(highlight = -1) {
    ctx.clearRect(0, 0, cssW, cssH);
    __pieSlices.forEach((sl, idx) => {
      const bump = (idx === highlight) ? 8 : 0;
      const mid  = (sl.s + sl.e) / 2;
      const mx   = Math.cos(mid) * bump, my = Math.sin(mid) * bump;

      ctx.beginPath();
      ctx.arc(cx + mx, cy + my, R, sl.s, sl.e, false);
      ctx.arc(cx + mx, cy + my, r, sl.e, sl.s, true);
      ctx.closePath();

      // fill & subtle depth shadow
      ctx.fillStyle = sl.color;
      ctx.globalAlpha = (idx === highlight) ? 1 : 0.92;
      ctx.shadowColor = 'rgba(0,0,0,.25)';
      ctx.shadowBlur  = (idx === highlight) ? 16 : 8;
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.globalAlpha = 1;
    });
  }

  // re-render on element resize (keeps hover zones aligned)
  if (!cvs.__ro) {
    cvs.__ro = new ResizeObserver(() => renderPie(data));
    cvs.__ro.observe(cvs);
  }
}



/* Canvas weekly line renderer — draws into #weeklyCanvas if present */
// gradient line with hover tooltip
function renderWeekly(data) {
  const cvs = document.getElementById('weeklyCanvas'); if (!cvs) return;
  const tip = document.getElementById('chartTip');
  const ctx = cvs.getContext('2d'); const W=cvs.width, H=cvs.height;
  ctx.clearRect(0,0,W,H);
  const L=56,R=10,T=14,B=34;

  const maxQ = Math.max(1, ...data.map(d=>d.qty||0));
  const n = Math.max(1, data.length);
  const stepX = (W - L - R) / Math.max(1,n-1);

  // axes + grid
  ctx.strokeStyle="#2b3546"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,H-B); ctx.lineTo(W-R,H-B); ctx.stroke();

  ctx.fillStyle="#94a3b8"; ctx.font="11px system-ui";
  for (let i=0;i<=4;i++){
    const q = Math.round((i/4)*maxQ);
    const y = H-B - ((H-B-T) * (q/maxQ));
    ctx.fillText(String(q), 8, y+4);
    ctx.strokeStyle="rgba(148,163,184,.16)";
    ctx.beginPath(); ctx.moveTo(L,y); ctx.lineTo(W-R,y); ctx.stroke();
  }

  // gradient under line
  const g = ctx.createLinearGradient(0,T,0,H-B);
  g.addColorStop(0,'hsla(262, 83%, 62%, .35)');
  g.addColorStop(1,'hsla(262, 83%, 62%, 0)');

  // line path + area
  ctx.beginPath();
  data.forEach((d,i)=>{
    const x = L + i*stepX;
    const y = H-B - ((H-B-T) * ((d.qty||0)/maxQ));
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle='hsl(262 83% 62%)'; ctx.lineWidth=2; ctx.stroke();

  // area
  ctx.lineTo(L + (n-1)*stepX, H-B);
  ctx.lineTo(L, H-B); ctx.closePath();
  ctx.fillStyle = g; ctx.fill();

  // points
  data.forEach((d,i)=>{
    const x = L + i*stepX;
    const y = H-B - ((H-B-T) * ((d.qty||0)/maxQ));
    ctx.fillStyle='hsl(262 83% 62%)';
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });

  // hover
  cvs.onmousemove = (evt)=>{
    const rect = cvs.getBoundingClientRect();
    const mx = evt.clientX - rect.left;
    const i = Math.max(0, Math.min(n-1, Math.round((mx - L)/stepX)));
    const x = L + i*stepX;
    const y = H-B - ((H-B-T) * ((data[i].qty||0)/maxQ));
    // clear & redraw small crosshair
    renderWeekly.baseDrawn || (renderWeekly.baseDrawn = ctx.getImageData(0,0,W,H));
    ctx.putImageData(renderWeekly.baseDrawn,0,0);
    ctx.strokeStyle='rgba(148,163,184,.35)'; ctx.setLineDash([4,4]);
    ctx.beginPath(); ctx.moveTo(x,T); ctx.lineTo(x,H-B); ctx.stroke(); ctx.setLineDash([]);

    // tip
    tip.textContent = `${data[i].week} – ${Math.round(data[i].qty||0)}`;
    tip.style.left = `${evt.clientX}px`;
    tip.style.top = `${evt.clientY}px`;
    tip.style.display = 'block';
  };
  cvs.onmouseleave = ()=>{ tip.style.display='none'; };
}
/* ===========================
   AUTH • Login/Signup + Gate
   - Shows on first load
   - Calls FastAPI JWT (/auth/login-json, /auth/register, /auth/me)
   - Falls back to "demo role" if API unreachable (optional)
=========================== */

// --- global fetch wrapper so your existing calls carry the token ---
function getInitials(email) {
  if (!email) return "U";
  const name = email.split("@")[0] || "user";
  return (name[0] || "U").toUpperCase();
}

function logoutAndBackToLogin() {
  try {
    localStorage.removeItem("WARESYS_TOKEN");
    localStorage.removeItem("WARESYS_ROLE");
  } catch {}
  location.reload(); // AuthGate will show login again
}

function UserChip() {
  const [me, setMe] = React.useState({ email: "", role: localStorage.getItem("WARESYS_ROLE") || "user" });
  const api = (localStorage.getItem("WARESYS_API") || "").replace(/\/+$/, "");

  React.useEffect(() => {
    (async () => {
      try {
        if (!api) return;
        const r = await fetch(api + "/auth/me");
        if (r.ok) {
          const j = await r.json();
          setMe({ email: j.email || "", role: j.role || (localStorage.getItem("WARESYS_ROLE") || "user") });
        }
      } catch {}
    })();
  }, []);

  const initial = getInitials(me.email || "a");
  const name = (me.email || "").split("@")[0] || "admin";
  const role = me.role || "user";

  return (
    <div className="flex items-center gap-2 bg-white/80 border border-slate-200 rounded-full px-2 py-1 shadow-sm">
      <div className="w-7 h-7 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold">
        {initial}
      </div>
      <span className="font-semibold text-slate-800">{name}</span>
      <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
        {role}
      </span>
      <button
        onClick={logoutAndBackToLogin}
        className="ml-2 text-sm px-3 py-1 rounded-md bg-blue-600 hover:bg-blue-700 text-white"
      >
        Logout
      </button>
    </div>
  );
}

(() => {
  const _fetch = window.fetch.bind(window);
  window.fetch = (input, init = {}) => {
    try {
      const base = (localStorage.getItem("WARESYS_API") || "").replace(/\/+$/, "");
      const tok = localStorage.getItem("WARESYS_TOKEN") || "";
      const url = typeof input === "string" ? input : (input && input.url) || "";
      if (tok && base && typeof url === "string" && url.indexOf(base) === 0) {
        init.headers = new Headers(init.headers || {});
        if (!init.headers.has("Authorization")) init.headers.set("Authorization", "Bearer " + tok);
      }
    } catch {}
    return _fetch(input, init);
  };
})();

function apiBase() {
  return (localStorage.getItem("WARESYS_API") || "").replace(/\/+$/, "");
}

async function apiLogin(email, password) {
  const base = apiBase();
  if (!base) throw new Error("WARESYS_API is not set");
  const r = await fetch(base + "/auth/login-json", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password }),
  });
  if (!r.ok) throw new Error("Invalid credentials");
  const j = await r.json();
  return j.access_token;
}

async function apiRegister(email, password) {
  const base = apiBase();
  if (!base) throw new Error("WARESYS_API is not set");
  const r = await fetch(base + "/auth/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password, role: "user" }),
  });
  if (!r.ok) {
    const t = await r.text();
    throw new Error(t || "Registration failed");
  }
  return true;
}

async function apiMe() {
  const base = apiBase();
  if (!base) return null;
  const r = await fetch(base + "/auth/me");
  if (!r.ok) return null;
  return r.json();
}

// --- tiny validators ---
const isEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
const minLen = (v, n) => (v || "").trim().length >= n;

// --- Login Card UI (like your screenshot) ---
function AuthCard({ mode, onMode, onSuccess }) {
  const [email, setEmail] = React.useState("");
  const [password, setPassword] = React.useState("");
  const [loading, setLoading] = React.useState(false);
  const [error, setError] = React.useState("");

  const canSubmit =
    isEmail(email) && minLen(password, 5) && !loading;

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    if (!canSubmit) return;
    setLoading(true);
    try {
      if (mode === "login") {
        // Try JWT
        let token = await apiLogin(email, password);
        localStorage.setItem("WARESYS_TOKEN", token);

        // fetch role; default to 'user'
        let role = "user";
        try {
          const me = await apiMe();
          if (me?.role) role = me.role;
        } catch {}
        localStorage.setItem("WARESYS_ROLE", role);

        onSuccess({ email, role, token });
      } else {
        // Sign up
        await apiRegister(email, password);
        alert("Account created. Please sign in.");
        onMode("login");
      }
    } catch (e) {
      // Optional: fallback demo (uncomment if you want no-API demo)
      // localStorage.setItem("WARESYS_ROLE", "admin");
      // onSuccess({ email, role: "admin", token: "" });
      setError(e?.message || "Something went wrong");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen w-full relative flex items-center justify-center overflow-hidden">
      {/* Blurred background layer */}
      <div className="absolute inset-0 -z-10 pointer-events-none">
        <div
          className="w-full h-full bg-center bg-cover"
          style={{
            backgroundImage: "url('/static/warehouse-bg.jpg')",
            filter: "blur(10px)",          // <- tweak: 6–14px
            transform: "scale(1.06)",      // prevents edge bleed from blur
          }}
        />
        {/* soft wash over the image to increase card contrast */}
        <div className="absolute inset-0 bg-white/35" />
      </div>

      {/* glassy login card */}
      <div className="relative z-10 w-full max-w-md">
        <div className="backdrop-blur-md bg-white/75 shadow-xl rounded-2xl p-8 border border-white/60">
          <h2 className="text-3xl font-black text-center tracking-widest mb-6">LOGIN</h2>

          {/* ...rest of the form exactly as before... */}


          {error && (
            <div className="mb-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">Email</label>
              <input
                type="email"
                className="w-full rounded-lg border border-slate-300 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-400"
                placeholder="e.g. arthur@camelot.io"
                value={email}
                onChange={(e)=>setEmail(e.target.value)}
                required
              />
              {!isEmail(email) && email && (
                <p className="text-xs text-red-600 mt-1">Enter a valid email</p>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
              <input
                type="password"
                className="w-full rounded-lg border border-slate-300 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-400"
                placeholder="••••••••"
                value={password}
                onChange={(e)=>setPassword(e.target.value)}
                minLength={5}
                required
              />
              {!minLen(password,5) && password && (
                <p className="text-xs text-red-600 mt-1">At least 5 characters</p>
              )}
            </div>

            <button
              type="submit"
              disabled={!canSubmit}
              className={"w-full rounded-lg py-2 font-semibold text-white transition " +
                (canSubmit ? "bg-violet-600 hover:bg-violet-700" : "bg-violet-300 cursor-not-allowed")}
            >
              {loading ? (mode === "login" ? "Signing in..." : "Creating...") : (mode === "login" ? "Sign in" : "Create account")}
            </button>
          </form>

          <p className="text-center text-sm text-slate-700 mt-4">
            {mode === "login" ? (
              <>New here? <button className="underline" onClick={()=>onMode("signup")}>Create an account</button></>
            ) : (
              <>Already have an account? <button className="underline" onClick={()=>onMode("login")}>Sign in</button></>
            )}
          </p>
        </div>
      </div>
    </div>
  );
}

// --- Gate that decides: show login or your existing <App/> ---
function AuthGate(){
  const [token, setToken] = React.useState(localStorage.getItem("WARESYS_TOKEN") || "");
  const [mode, setMode] = React.useState("login"); // or "signup"
  const [checking, setChecking] = React.useState(!!token);

  React.useEffect(() => {
    // on first load, if we have a token, verify it
    (async () => {
      if (!token) return;
      try {
        const me = await apiMe();
        if (!me) throw new Error("bad token");
        // keep role around for your existing UI
        if (me.role) localStorage.setItem("WARESYS_ROLE", me.role);
      } catch {
        localStorage.removeItem("WARESYS_TOKEN");
        localStorage.removeItem("WARESYS_ROLE");
        setToken("");
      } finally {
        setChecking(false);
      }
    })();
  }, []);

  if (checking) return null; // tiny flicker fix

  if (!token) {
    return <AuthCard mode={mode} onMode={setMode} onSuccess={({token})=>{
      if (token) setToken(token);
      // soft reload not required; but if you want:
      // location.reload();
    }} />;
  }
  return <App />; // your existing dashboard
}
/* ===== Notifications tidy: emoji map + count pill + row ===== */
const CATEGORY_EMOJI = {
  "Tiles": "🧱",
  "Sanitaryware (Ceramic)": "🚿",     // or "🛁" if you prefer
  "Metal Fixtures & Fittings": "🔧",
  "Connectors & Fasteners": "🔩",
  "Mirrors & Glass": "🪞",
  "Adhesives, Chemicals & Tapes": "🧪",
};

function getCategoryEmoji(cat) {
  if (!cat) return "📦";
  if (CATEGORY_EMOJI[cat]) return CATEGORY_EMOJI[cat];
  // fuzzy fallback (tolerant to minor name differences)
  const k = Object.keys(CATEGORY_EMOJI).find(k =>
    (cat || "").toLowerCase().includes(k.toLowerCase().split(" ")[0])
  );
  return (k && CATEGORY_EMOJI[k]) || "📦";
}

function CountPill({ qty, reorder }) {
  const q = Number(qty ?? 0);
  const r = Math.max(1, Number(reorder ?? 0)); // avoid divide-by-zero cases
  const pct = q / r;

  const tone =
    pct <= 1 ? "red" : pct <= 1.5 ? "amber" : "slate";

  const wrap =
    tone === "red"
      ? "bg-red-50 text-red-700 border-red-200"
      : tone === "amber"
      ? "bg-amber-50 text-amber-700 border-amber-200"
      : "bg-slate-50 text-slate-700 border-slate-200";

  return (
    <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-md border text-xs font-medium ${wrap}`}>
      <span className="tabular-nums">{q}</span>
      <span className="opacity-50">/</span>
      <span className="tabular-nums">{r}</span>
    </span>
  );
}
/* ===== Demo Parser Accuracy (90–95%) ===== */
function useDemoParserAccuracy(trigger) {
  // read or initialize
  const [acc, setAcc] = React.useState(() => {
    const saved = Number(localStorage.getItem("WARESYS_DEMO_ACC") || "0");
    if (saved) return saved;
    const init = Math.round((92 + Math.random() * 3) * 10) / 10; // 92.0–95.0 start
    localStorage.setItem("WARESYS_DEMO_ACC", init);
    return init;
  });
  const [delta, setDelta] = React.useState(0);

  React.useEffect(() => {
    // small random nudge within [90,95], ±0.0–0.8
    const last = acc;
    let next = last + (Math.random() * 0.8 - 0.4);
    next = Math.max(90, Math.min(95, next));
    next = Math.round(next * 10) / 10;
    setAcc(next);
    setDelta(Math.round((next - last) * 10) / 10);
    try { localStorage.setItem("WARESYS_DEMO_ACC", next); } catch {}
    // eslint-disable-next-line
  }, [trigger]);

  return { acc, delta };
}
/* ===== Live Clock (chip) ===== */
function useClock() {
  const [now, setNow] = React.useState(() => new Date());
  React.useEffect(() => {
    const t = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(t);
  }, []);
  // format: DD/MM/YYYY, hh:mm:ss AM/PM
  const dd = String(now.getDate()).padStart(2, "0");
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const yyyy = now.getFullYear();
  let hh = now.getHours();
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  const HH = String(hh).padStart(2, "0");
  const min = String(now.getMinutes()).padStart(2, "0");
  const sec = String(now.getSeconds()).padStart(2, "0");
  const text = `${dd}/${mm}/${yyyy}, ${HH}:${min}:${sec} ${ampm}`;
  return text;
}

function ClockChip() {
  const text = useClock();
  return (
    <div className="hidden sm:inline-block rounded-full bg-white/70 border border-white/60 shadow-sm px-4 py-1 text-sm text-slate-600">
      {text}
    </div>
  );
}


      function App(){
        // modal (kept to preserve previous feature) — not used by the new expand-in-table UX
        const [viewerOpen, setViewerOpen] = useState(false);
        const [viewerLoading, setViewerLoading] = useState(false);
        const [viewerBill, setViewerBill] = useState(null);
        const [parseTick, setParseTick] = React.useState(0);
const demoAcc = useDemoParserAccuracy(parseTick);


        async function openBillViewer(id) {
          setViewerOpen(true);
          setViewerLoading(true);
          try {
            const r = await fetch(API + "/bills/" + id, { cache: "no-store" });
            const raw = r.ok ? await r.json() : null;
            setViewerBill(mapServerBill(raw || {}));
          } finally {
            setViewerLoading(false);
          }
        }

        const API = useMemo(() => {
          try {
            const raw = (localStorage.getItem("WARESYS_API") || "").trim();
            return raw ? raw.replace(/\/+$/, "") : window.location.origin;
          } catch { return window.location.origin; }
        }, []);

        // role / tabs
        const [role, setRole] = useState(() => localStorage.getItem("WARESYS_ROLE") || "manager");
        useEffect(()=>localStorage.setItem("WARESYS_ROLE", role), [role]);
        const [tab, setTab] = useState("dashboard");

        const [kpi, setKpi] = useState({ invoicesToday: 0, linesToday: 0, accuracy: 0, stockValue: 0 });

        // bills list
        const [loadingBills, setLoadingBills] = useState(true);
        const [bills, setBills] = useState([]);
        // Build normalized list + chart datasets
const normalizedBills = useMemo(() => (bills || []).map(b => mapServerBill(b)), [bills]);
const { pieData: categorySplitData, weeklyData } = useMemo(
  () => buildCategoryAggregates(normalizedBills),
  [normalizedBills]
);

        // Recompute dashboard KPIs from the fetched bills
useEffect(()=>{
  const normalized = (bills || []).map(b => mapServerBill(b));

  // Invoices parsed today
  const todayKey = new Date().toISOString().slice(0,10);
  const invoicesToday = normalized.filter(b => (b.bill_date || '').slice(0,10) === todayKey).length;

  // Lines parsed (total across all bills)
  const linesToday = normalized.reduce((s,b)=> s + ((b.lines && b.lines.length) || 0), 0);

  // Parser accuracy (avg of ocr_confidence/accuracy fields if present)
  const accVals = normalized
    .map(b => Number(b.accuracy ?? b.ocr_confidence ?? 0))
    .filter(v => v > 0 && isFinite(v));
  const accuracy = accVals.length ? (accVals.reduce((a,v)=>a+v,0) / accVals.length) : 0;

  // Stock value = sum(qty * unit_price) for categorized items only
  let stockValue = 0;
  normalized.forEach(b => (b.lines || []).forEach(ln => {
    const tag = categorizeHSN(ln.hsn);
    if (!tag) return;
    stockValue += (Number(ln.qty)||0) * (Number(ln.unit_price ?? ln.rate) || 0);
  }));

  setKpi({ invoicesToday, linesToday, accuracy, stockValue });
}, [bills]);

        async function refreshRecent() {
          setLoadingBills(true);
          try{
            await fetch(API + "/api/health", { cache: "no-store" }).catch(()=>null);
            const r = await fetch(API + "/bills?limit=12", { cache: "no-store" }).catch(()=>null);
            const data = r && r.ok ? await r.json() : demoBills();
            setBills(data);
          } catch {
            setBills(demoBills());
          } finally {
            setLoadingBills(false);
          }
        }
        useEffect(()=>{ refreshRecent(); },[API]);
        // Build products for the Stock tab from scanned bills (top-level hook; not conditional)
const stockProducts = useMemo(
  () => buildProductsFromBills((bills || []).map(b => mapServerBill(b))),
  [bills]
);
// Category stock vs reorder chart data
const catStockData = useMemo(() => aggregateCategoryStock(stockProducts || []), [stockProducts]);

// ---- Low-stock notifications (poll backend every 30s; fallback to client aggregation) ----
const [notifications, setNotifications] = useState([]);
async function fetchLowNotifications() {
  try {
    const r = await fetch(API + "/stock/low", { cache: "no-store" }).catch(()=>null);
    if (r && r.ok) {
      const arr = await r.json();
      if (Array.isArray(arr) && arr.length) {
        const mapped = arr.map(x => ({
          id: x.id || x.product_id || x.hsn || x.name,
          name: x.name || x.product_name || "(unknown item)",
          category: x.category || "",
          stock_qty: Number(x.stock_qty ?? x.qty ?? 0),
          reorder_point: Number(x.reorder_point ?? (REORDER_BY_CATEGORY[(x.category||"")] ?? 20)),
        })).filter(n => n.stock_qty < n.reorder_point);
        setNotifications(mapped);
        return;
      }
    }
  } catch {}
  // Fallback: derive from client products built from invoices
  const fb = (stockProducts || [])
    .filter(p => (p.stock_qty||0) < (p.reorder_point||20))
    .map(p => ({
      id: p.sku || p.hsn || p.name,
      name: p.name,
      category: p.category || "",
      stock_qty: p.stock_qty || 0,
      reorder_point: p.reorder_point || 20,
    }));
  setNotifications(fb);
}
useEffect(() => {
  fetchLowNotifications();
  const t = setInterval(fetchLowNotifications, 30000);
  return () => clearInterval(t);
}, [API, stockProducts]);

        // When CDN charts are blocked, draw local canvas charts using parsed bills
useEffect(()=>{
  if (window.Recharts && window.Recharts.BarChart && window.Recharts.PieChart) return; // CDN available → do nothing
  // normalize bills once using your existing mapper
  const normalized = (bills || []).map(b => mapServerBill(b));
  const { pieData, weeklyData } = buildCategoryAggregates(normalized);
  // give the UI a tick to mount canvases (no-op if not present)
  requestAnimationFrame(()=>{
    renderPie(pieData);
    renderWeekly(weeklyData);
  });
}, [bills]);


        // products/stock
        const [loadingProducts, setLoadingProducts] = useState(true);
        const [products, setProducts] = useState([]);
        useEffect(()=>{
          let cancel=false;
          (async()=>{
            setLoadingProducts(true);
            try{
              const r = await fetch(API + "/products", { cache:"no-store" }).catch(()=>null);
              const data = r && r.ok ? await r.json() : demoProducts();
              if(!cancel) setProducts(data);
            } catch {
              if(!cancel) setProducts(demoProducts());
            } finally {
              if(!cancel) setLoadingProducts(false);
            }
          })();
          return ()=>{cancel=true};
        },[API]);

        // OCR inbox
        const [uploading,setUploading]=useState(false);
        const [pct,setPct]=useState(0);
        const [step,setStep]=useState(0); // 0..6
        const fileRef=useRef(null);
        const [vendorInput,setVendorInput]=useState("");
        const [billDateInput, setBillDateInput] = useState(""); // YYYY-MM-DD from <input type="date">
        const [extracted,setExtracted]=useState(null);
        const [lastBillId,setLastBillId]=useState(null);

        const startPipeline = () => {
          setStep(0);
          let s=0; const t=setInterval(()=>{ s+=1; setStep(s); if(s>=6) clearInterval(t); }, 650);
        };

        const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

        const startUpload = async (files)=>{
          if(!files || !files.length) return;
          if(!(vendorInput && vendorInput.trim())) {
            alert("Please enter the Vendor name before parsing.");
            return;
          }
          if(!billDateInput){
            alert("Please select the Invoice Date before parsing.");
            return;
          }
          setUploading(true); setPct(0);
          const timer=setInterval(()=>setPct(p=>p>=95?95:p+4),80);
          try{
            const fd = new FormData();
            Array.from(files).forEach(f=>fd.append("file", f));
            if (vendorInput.trim()) fd.append("party_name", vendorInput.trim());
            fd.append("bill_date", billDateInput); // YYYY-MM-DD


            const r = await fetch(API + "/bills/ocr", { method:"POST", body: fd }).catch(()=>null);
            const data = r && r.ok ? await r.json() : {};
            setPct(100); clearInterval(timer); startPipeline();

            const id = data.bill_id || data.id;
            setLastBillId(id || null);

            // Poll until processed
            let tries = 0, bill = null;
            while (id && tries < 30) {
              await sleep(1500);
              const r2 = await fetch(API + "/bills/" + id, { cache: "no-store" }).catch(()=>null);
              if (r2 && r2.ok) {
                const raw = await r2.json();
                if (raw?.status === "PROCESSED" && Array.isArray(raw.lines) && raw.lines.length) {
                  bill = mapServerBill(raw);
                  setParseTick(t => t + 1);
                  break;
                }
              }
              tries++;
            }
            if (bill) setExtracted(bill);
            if (bill) { setExtracted(bill); setParseTick(t => t + 1); }
            await refreshRecent();

          } finally {
            clearInterval(timer); setUploading(false);
          }
        };

        const onUploadClick = ()=>{ setTab("ocr"); setTimeout(()=>fileRef.current?.click(), 60); };

        // Fetch one bill (used by table expand)
        async function fetchBillById(id){
          const r = await fetch(API + "/bills/" + id, { cache: "no-store" }).catch(()=>null);
          if (r && r.ok) {
            const raw = await r.json();
            return mapServerBill(raw);
          }
          return null;
        }

        return (
          <div className="min-h-screen">
            <div className="pointer-events-none fixed inset-x-0 top-0 h-40 bg-gradient-to-b from-violet-200/60 via-fuchsia-100/40 to-transparent blur-2xl"></div>

            <div className="flex">
              <Sidebar tab={tab} setTab={setTab} onUploadClick={onUploadClick} />

              <main className="flex-1 p-4 md:p-6 xl:p-8">
                <Topbar
                role={role}
                setRole={setRole}
                API={API}
                setTab={setTab}
                onOpenBill={openBillViewer}
                notifications={notifications}
              />

                {tab==="dashboard" && (
                  <>
                    <section className="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
                      <KPI title="Invoices Parsed (today)" value={kpi.invoicesToday} delta="+12%" />
                      <KPI title="Line Items Parsed" value={kpi.linesToday} delta="+8%" />
                      <KPI
  title="Parser Accuracy"
  value={demoAcc.acc.toFixed(1) + '%'}
  delta={(demoAcc.delta >= 0 ? '+' : '') + Math.abs(demoAcc.delta).toFixed(1) + '%'}
/>
                      <KPI title="Total Stock Value" value={fmtINR(kpi.stockValue)} delta="+₹1.2L" />
                    </section>
<section className="mt-6 grid gap-6 lg:grid-cols-3">
<Card className="lg:col-span-2">
  <CardHeader title="Category Stock" subtitle="Stock vs reorder point by category" />
  <CategoryStockBar data={catStockData} />
</Card>

  <Card>
    <CardHeader title="Category Split" subtitle="Products by category" />
    <CategorySplitDonut data={categorySplitData} />
  </Card>
</section>


                    <Card className="mt-6">
                      <CardHeader title="Recent OCR Documents" subtitle="Latest uploads and statuses" />
                      <RecentTable
                        rows={bills}
                        loading={loadingBills}
                        fetchBillById={fetchBillById}
                      />
                    </Card>
                  </>
                )}

                {tab==="ocr" && (
                  <section className="grid gap-6">
                    <Card>
                      <CardHeader title="OCR Pipeline" subtitle="Upload → OCR → Parse → Match → Validate → Stock" />
                      <div className="px-4 pb-4">
                        <Pipeline step={step} />
                        <div className="mt-4 grid gap-4 md:grid-cols-3">
                          <div className="md:col-span-2 rounded-xl border border-slate-200 bg-white p-4">
                            <Uploader
                              inputRef={fileRef}
                              uploading={uploading}
                              percent={pct}
                              vendorProvided={!!(vendorInput && vendorInput.trim())}
                              onFiles={fl => startUpload(fl)}
                            />
                            <div className="mt-3 flex items-center gap-2">
                              <label className="text-sm text-slate-600">Vendor Name (required):</label>
                              <input
                                value={vendorInput}
                                onChange={e=>setVendorInput(e.target.value)}
                                placeholder="e.g., A2Z Buildwares"
                                className="rounded-lg border border-slate-300 bg-white px-2 py-1.5 text-sm w-64"
                              />
                            </div>
                            <div className="mt-3 flex items-center gap-2">
  <label className="text-sm text-slate-600">Invoice Date (required):</label>
  <input
    type="date"
    value={billDateInput}
    onChange={e=>setBillDateInput(e.target.value)}
    className="rounded-lg border border-slate-300 bg-white px-2 py-1.5 text-sm w-48"
  />
</div>

                          </div>
                          <div className="rounded-xl border border-slate-200 bg-white p-4">
                            <div className="text-sm font-semibold mb-2">Extracted Header</div>
                            {!extracted && <div className="text-sm text-slate-500">Upload a bill to see OCR’d header.</div>}
                            {extracted && (
                              <dl className="text-sm grid grid-cols-3 gap-x-3 gap-y-2">
                                <dt className="text-slate-500">Bill #</dt><dd className="col-span-2">{extracted.bill_no || "—"}</dd>
                                <dt className="text-slate-500">Date</dt><dd className="col-span-2">{fmtDate(extracted.bill_date)}</dd>
                                <dt className="text-slate-500">Vendor</dt><dd className="col-span-2">{(vendorInput && vendorInput.trim()) ? vendorInput.trim() : (extracted.party_name || "—")}</dd>
                                <dt className="text-slate-500">GST Number</dt><dd className="col-span-2">{extracted.gstin || "—"}</dd>
                                <dt className="text-slate-500">Total</dt><dd className="col-span-2">{fmtINR(extracted.pre_total ?? extracted.total)}</dd>
                              </dl>
                            )}
                            {lastBillId && <div className="mt-3 text-xs text-slate-500">Bill ID: {lastBillId}</div>}
                          </div>
                        </div>
                      </div>
                    </Card>

                    <Card>
                      <CardHeader title="Recent OCR Documents" subtitle="Latest uploads and statuses" />
                      <RecentTable
                        rows={bills}
                        loading={loadingBills}
                        fetchBillById={fetchBillById}
                      />
                    </Card>
                  </section>
                )}

                        {tab==="products" && (
          <Card>
            <CardHeader title="Categories & HSN" subtitle="Auto-compiled from invoices (HSN groups)" />
            <CategoryHSN bills={bills} loading={loadingBills} />
          </Card>
        )}


                {tab==="stock" && (
  <Card>
    <CardHeader title="Stock (All Products)" subtitle="From scanned invoices" />
    <StockTable products={stockProducts} loading={loadingBills} />
  </Card>
)}

                {/* Keeps the previous modal feature available if you want it */}

                <BillViewer
                  open={viewerOpen}
                  loading={viewerLoading}
                  bill={viewerBill}
                  onClose={()=>setViewerOpen(false)}
                />
              </main>
            </div>
          </div>
        );
      }

      // ---------------- UI components
      function Sidebar({ tab, setTab, onUploadClick }){
        const Item=({label,active,onClick,badge})=>(
          <button onClick={onClick}
            className={`flex w-full items-center justify-between rounded-xl px-3 py-2.5 text-sm transition
                        ${active?'bg-violet-50 text-violet-700 ring-1 ring-violet-200':'text-slate-700 hover:bg-slate-100 hover:text-slate-900'}`}>
            <span>{label}</span>
            {badge && <span className="rounded bg-slate-100 px-2 py-0.5 text-[10px] text-slate-600">{badge}</span>}
          </button>
        );
        return (
          <aside className="sticky top-0 hidden h-screen w-64 shrink-0 flex-col border-r border-slate-200 bg-white/70 p-4 backdrop-blur lg:flex">
   <div className="flex items-center gap-3 mb-4">
  <img src="/static/waresys-logo.png" alt="WARESYS" className="h-12 w-12 rounded-xl object-contain shadow-sm" />
  <div>
    <div className="text-xl font-extrabold tracking-wide">WARESYS</div>
    <div className="text-xs text-slate-500">OCR • Inventory • Analytics</div>
  </div>
</div>

<nav className="mt-4 space-y-2">

              <Item label="Dashboard" active={tab==='dashboard'} onClick={()=>setTab('dashboard')} />
              <Item label="OCR Inbox" active={tab==='ocr'} onClick={()=>setTab('ocr')} />
              <Item label="Categories"  active={tab==='products'} onClick={()=>setTab('products')} />
              <Item label="Stock"     active={tab==='stock'} onClick={()=>setTab('stock')} />
            </nav>
            <div className="mt-auto space-y-2">
              <button
                onClick={onUploadClick}
                className="w-full rounded-xl bg-gradient-to-r from-violet-600 to-fuchsia-600 px-3 py-2.5 text-sm font-semibold text-white shadow hover:opacity-95">
                Upload
              </button>
            </div>
          </aside>
        );
      }

      function Topbar({ role, setRole, API, setTab, onOpenBill, notifications }){
  // ---- Search ----
  const [q, setQ] = useState("");
  const [openSearch, setOpenSearch] = useState(false);
  const [searching, setSearching] = useState(false);
  const [results, setResults] = useState({ bills:[], products:[], vendors:[] });

  useEffect(()=>{
    if (!q || !q.trim()) { setResults({bills:[],products:[],vendors:[]}); setOpenSearch(false); return; }
    const t = setTimeout(async ()=>{
      setSearching(true);
      try{
        const r = await fetch(API + "/search?q=" + encodeURIComponent(q.trim()));
        if (r.ok) {
          const data = await r.json();
          setResults({
            bills: Array.isArray(data.bills)? data.bills : [],
            products: Array.isArray(data.products)? data.products : [],
            vendors: Array.isArray(data.vendors)? data.vendors : [],
          });
          setOpenSearch(true);
        }
      } finally { setSearching(false); }
    }, 300);
    return ()=>clearTimeout(t);
  }, [q, API]);

  function selectResult(item){
    setOpenSearch(false);
    setQ("");
    if (item.type === "bill" && item.id) {
      onOpenBill?.(item.id);
    } else if (item.type === "product") {
      setTab?.("stock");
    } else if (item.type === "vendor") {
      setTab?.("dashboard");
    }
  }

  // ---- Notifications (low stock) ----
  const [notifOpen, setNotifOpen] = useState(false);
  const notifCount = notifications?.length || 0;

  return (
    <header className="mb-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between relative">
      <div className="flex items-center gap-3">
        <div className="relative">
          <input
            value={q}
            onChange={(e)=>setQ(e.target.value)}
            placeholder="Search bills, vendors, products…"
            className="w-[300px] rounded-xl border border-slate-200 bg-white pl-3 pr-3 py-2 text-sm outline-none placeholder:text-slate-400 focus:ring-2 focus:ring-violet-300" />
          {openSearch && (
            <div className="absolute z-40 mt-1 w-[360px] rounded-xl border border-slate-200 bg-white shadow">
              <div className="max-h-80 overflow-auto text-sm">
                {(!results.bills.length && !results.products.length && !results.vendors.length) && (
                  <div className="px-3 py-2 text-slate-500">No results</div>
                )}
                {results.bills.length>0 && (
                  <>
                    <div className="px-3 py-1 text-[11px] uppercase tracking-wide text-slate-400">Bills</div>
                    {results.bills.map(b=>(
                      <button key={"b"+b.id} onClick={()=>selectResult(b)}
                        className="flex w-full items-center justify-between px-3 py-2 hover:bg-slate-50">
                        <span className="truncate"><span className="font-medium">{b.bill_no}</span> · {b.party_name || "—"}</span>
                        <span className="text-xs text-slate-500">{b.bill_date || ""}</span>
                      </button>
                    ))}
                    <div className="border-t"></div>
                  </>
                )}
                {results.products.length>0 && (
                  <>
                    <div className="px-3 py-1 text-[11px] uppercase tracking-wide text-slate-400">Products</div>
                    {results.products.map(p=>(
                      <button key={"p"+p.id} onClick={()=>selectResult(p)}
                        className="flex w-full items-center justify-between px-3 py-2 hover:bg-slate-50">
                        <span className="truncate"><span className="font-medium">{p.name || "—"}</span> · {p.category || ""}</span>
                        <span className="text-xs text-slate-500">{p.hsn || ""}</span>
                      </button>
                    ))}
                    <div className="border-t"></div>
                  </>
                )}
                {results.vendors.length>0 && (
                  <>
                    <div className="px-3 py-1 text-[11px] uppercase tracking-wide text-slate-400">Vendors</div>
                    {results.vendors.map(v=>(
                      <button key={"v"+v.id} onClick={()=>selectResult(v)}
                        className="flex w-full items-center justify-between px-3 py-2 hover:bg-slate-50">
                        <span className="truncate font-medium">{v.name}</span>
                        <span className="text-xs text-slate-500">Vendor</span>
                      </button>
                    ))}
                  </>
                )}
              </div>
            </div>
          )}
        </div>
        <ClockChip />
      </div>
      <div className="flex items-center gap-3 relative">
        <button onClick={()=>setNotifOpen(o=>!o)} className="relative grid h-9 w-9 place-items-center rounded-xl border border-slate-200 bg-white">
          🔔
          {notifCount>0 && (
            <span className="absolute -right-1 -top-1 grid h-5 w-5 place-items-center rounded-full bg-fuchsia-500 text-[10px] font-bold text-white">{notifCount}</span>
          )}
        </button>
       <UserChip />

        {notifOpen && (
          <div className="absolute right-0 top-10 z-40 w-[360px] rounded-xl border border-slate-200 bg-white shadow">
            <div className="px-3 py-2 border-b text-sm font-semibold">Notifications</div>
            <div className="max-h-80 overflow-auto text-sm">
              {notifCount===0 && <div className="px-3 py-3 text-slate-500">All good — no low stock.</div>}
                {notifications.map((n,i)=>(
    <div key={n.id ?? i} className="py-3 px-3 flex items-start justify-between gap-3 hover:bg-slate-50 rounded-lg">
      <div className="min-w-0">
        <div className="flex items-center gap-2">
          <span className="text-lg leading-none">{getCategoryEmoji(n.category)}</span>
          <span className="font-semibold text-slate-900 truncate">{n.name}</span>
        </div>
        <div className="mt-0.5 text-xs text-slate-500 truncate">
          {n.category || "Uncategorized"}
        </div>
      </div>
      <div className="shrink-0 mt-1">
        <CountPill qty={n.stock_qty} reorder={n.reorder_point} />
      </div>
    </div>
  ))}

            </div>
          </div>
        )}
      </div>
    </header>
  );
}


      function KPI({title,value,delta}){
        return (
          <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
            <div className="mb-2 text-xs text-slate-500">{title}</div>
            <div className="flex items-end justify-between">
              <div className="text-2xl font-semibold tracking-tight text-slate-900">{value}</div>
              <div className="text-xs text-emerald-600">{delta}</div>
            </div>
          </div>
        );
      }
      function Card({children,className=""}){ return <section className={`rounded-2xl border border-slate-200 bg-white shadow-sm ${className}`}>{children}</section>; }
      function CardHeader({title,subtitle}){ return (
        <div className="flex items-center justify-between border-b border-slate-200 px-4 py-3">
          <div><h3 className="text-sm font-semibold">{title}</h3>{subtitle && <p className="text-xs text-slate-500">{subtitle}</p>}</div>
          <button className="grid h-9 w-9 place-items-center rounded-xl border border-slate-200 bg-white">⚙️</button>
        </div>
      );}

      function Pipeline({step}){
        const steps = ["Upload","OCR","Parse","Match","Validate","Stock"];
        return (
          <ol className="grid grid-cols-6 gap-3">
            {steps.map((name,i)=>{
              const active = step >= i+1;
              return (
                <li key={name} className="flex flex-col items-center">
                  <div className={`grid h-12 w-12 place-items-center rounded-2xl border transition
                    ${active?'border-emerald-400/60 bg-emerald-50':'border-slate-200 bg-white'}`}>
                    <span className={active?"text-emerald-600":"text-slate-500"}>{active?"✔":"○"}</span>
                  </div>
                  <p className="mt-2 text-xs text-slate-600">{name}</p>
                </li>
              );
            })}
          </ol>
        );
      }

      // UPDATED: shows file name(s) + Clear, and blocks Choose until vendor is provided
      function Uploader({inputRef, uploading, percent, onFiles, vendorProvided}){
        const [drag,setDrag]=useState(false);
        const [fileLabel,setFileLabel]=useState('');
        const clear = () => {
          setFileLabel('');
          if (inputRef.current) inputRef.current.value = '';
        };
        const setNames = (fl) => setFileLabel(Array.from(fl||[]).map(f=>f.name).join(', '));

        return (
          <div onDragOver={(e)=>{e.preventDefault(); setDrag(true);}}
               onDragLeave={()=>setDrag(false)}
               onDrop={(e)=>{e.preventDefault(); setDrag(false); setNames(e.dataTransfer.files); onFiles(e.dataTransfer.files);}}
               className={`grid place-items-center rounded-xl border-2 border-dashed p-6 text-center ${drag?'border-violet-400/80 bg-violet-50':'border-slate-300'}`}>
            <input ref={inputRef} type="file" accept=".pdf,image/*" className="hidden"
                   onChange={(e)=>{ setNames(e.target.files); onFiles(e.target.files); }} />
            <div className="text-2xl mb-1 text-violet-600">⬆</div>
            <p className="text-sm text-slate-700">Drag & drop invoices (PDF/JPG/PNG) or</p>
            <button onClick={()=>inputRef.current?.click()}
              className="mt-2 inline-flex items-center gap-2 rounded-xl px-3 py-1.5 text-xs font-semibold text-white disabled:opacity-50"
              style={{background: vendorProvided ? 'linear-gradient(90deg,#7c3aed,#ec4899)' : '#cbd5e1'}}
              disabled={!vendorProvided}
              title={vendorProvided ? "Select file(s)" : "Enter vendor name first"}>
              Choose Files
            </button>

            {fileLabel && (
              <div className="mt-3 flex items-center gap-2 text-xs text-slate-600">
                <span className="font-medium truncate max-w-[60ch]">Selected: {fileLabel}</span>
                <button onClick={clear} className="rounded border border-slate-300 px-2 py-0.5 hover:bg-slate-50">Clear</button>
              </div>
            )}

            {uploading && (
              <div className="mt-4 w-full">
                <div className="mb-1 flex items-center justify-between text-xs text-slate-500">
                  <span>Uploading</span><span>{percent}%</span>
                </div>
                <div className="h-2 w-full rounded-full bg-slate-200">
                  <div className="h-2 rounded-full bg-gradient-to-r from-violet-500 to-fuchsia-500" style={{width:percent+"%"}}></div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // UPDATED: expands a row inline to show header (5 fields) + full lines
      function RecentTable({rows, loading, fetchBillById}){
        const [expandedId, setExpandedId] = useState(null);
        const [detailById, setDetailById] = useState({});
        const [loadingDetail, setLoadingDetail] = useState(false);

        async function toggleExpand(id){
          if (expandedId === id) { setExpandedId(null); return; }
          if (!detailById[id]) {
            setLoadingDetail(true);
            const d = await fetchBillById(id);
            setDetailById(prev => ({...prev, [id]: d}));
            setLoadingDetail(false);
          }
          setExpandedId(id);
        }

        return (
          <div className="overflow-x-auto">
            <table className="min-w-full text-left text-sm">
              <thead className="border-b border-slate-200 bg-slate-50 text-xs uppercase text-slate-500">
                <tr>
                  <th className="px-4 py-3">Bill #</th>
                  <th className="px-4 py-3">Vendor</th>
                  <th className="px-4 py-3">Date</th>
                  <th className="px-4 py-3">Lines</th>
                  <th className="px-4 py-3">Status</th>
                  <th className="px-4 py-3">Confidence</th>
                  <th className="px-4 py-3">Actions</th>
                </tr>
              </thead>
              <tbody>
                {loading && <tr><td className="px-4 py-10 text-center text-slate-500" colSpan="6">Loading…</td></tr>}
                {!loading && rows.map((r,i)=>{
                  const id = r.bill_id || r.id;
                  const isOpen = expandedId === id;
                  const detail = detailById[id];
                  return (
                    <React.Fragment key={id || i}>
                      <tr className="border-b border-slate-100 hover:bg-slate-50">
                        <td className="px-4 py-3 font-mono">{r.bill_no || id || "—"}</td>
                        {/* Only show the user-provided vendor (party_name) */}
                        <td className="px-4 py-3">{r.party_name || "—"}</td>
                        <td className="px-4 py-3">{fmtDate(r.bill_date)}</td>
                        <td className="px-4 py-3">{r.lines?.length ?? r.line_count ?? "—"}</td>
                        <td className="px-4 py-3">{(r.status||"").toUpperCase()}</td>
                        <td className="px-4 py-3">{r.accuracy? r.accuracy+"%":"—"}</td>
                        <td className="px-4 py-3">
                          <button
                            onClick={()=>toggleExpand(id)}
                            className="rounded-lg border border-slate-200 px-2 py-1 text-xs hover:bg-slate-50">
                            {isOpen ? "Close" : "Open"}
                          </button>
                        </td>
                      </tr>

                      {isOpen && (
                        <tr className="bg-white">
                          <td colSpan="7" className="px-4 pb-5">
                            {loadingDetail && !detail ? (
                              <div className="py-6 text-center text-slate-500">Loading details…</div>
                            ) : detail ? (
                              <div className="mt-3">
                               {/* Header */}
                                <div className="mb-3 grid grid-cols-2 gap-4">
                                  <div className="rounded-xl border border-slate-200 p-3">
                                    <div className="text-sm font-semibold mb-2">Header</div>
                                    <dl className="text-sm grid grid-cols-3 gap-x-3 gap-y-2">
                                      <dt className="text-slate-500">Bill #</dt><dd className="col-span-2">{detail.bill_no || "—"}</dd>
                                      <dt className="text-slate-500">Date</dt><dd className="col-span-2">{fmtDate(detail.bill_date)}</dd>
                                      <dt className="text-slate-500">Vendor</dt><dd className="col-span-2">{detail.party_name || "—"}</dd>
                                      <dt className="text-slate-500">GST Number</dt><dd className="col-span-2">{detail.gstin || "—"}</dd>
                                      <dt className="text-slate-500">Total</dt><dd className="col-span-2">{fmtINR(detail.pre_total ?? detail.total)}</dd>
                                    </dl>
                                  </div>
                                </div>

                               {/* Lines */}
                                <div className="rounded-xl border border-slate-200">
                                  <table className="min-w-full text-sm">
                                    <thead className="bg-slate-50 text-slate-500">
                                      <tr>
                                        <th className="px-3 py-2 text-left">#</th>
                                        <th className="px-3 py-2 text-left">Description</th>
                                        <th className="px-3 py-2 text-left">HSN</th>
                                        <th className="px-3 py-2 text-left">UOM</th>
                                        <th className="px-3 py-2 text-right">Qty</th>
                                        <th className="px-3 py-2 text-right">Rate</th>
                                        <th className="px-3 py-2 text-right">Amount</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {(detail.lines || []).map((ln, j) => (
                                        <tr key={j} className="border-t">
                                          <td className="px-3 py-2">{ln.idx || j+1}</td>
                                          <td className="px-3 py-2">{ln.description}</td>
                                          <td className="px-3 py-2">{ln.hsn}</td>
                                          <td className="px-3 py-2">{ln.uom}</td>
                                          <td className="px-3 py-2 text-right">{ln.qty}</td>
                                          <td className="px-3 py-2 text-right">{fmtINR(ln.rate)}</td>
                                          <td className="px-3 py-2 text-right">{fmtINR(ln.amount)}</td>
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            ) : (
                              <div className="py-6 text-center text-slate-500">No details available.</div>
                            )}
                          </td>
                        </tr>
                      )}
                    </React.Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>
        );
      }
// ---- Polished, stable charts ----
const COLORS = ["#7C3AED", "#10B981", "#3B82F6", "#F59E0B", "#EF4444", "#8B5CF6", "#06B6D4", "#84CC16"];

function renderActiveShape3D(props) {
  const RAD = Math.PI / 180;
  const { cx, cy, innerRadius, outerRadius, startAngle, endAngle, midAngle, fill } = props;
  const off = 8, mx = Math.cos(-midAngle * RAD) * off, my = Math.sin(-midAngle * RAD) * off;
  return (
    <g transform={`translate(${mx},${my})`} filter="url(#ds1)">
      <Sector cx={cx} cy={cy} innerRadius={innerRadius} outerRadius={outerRadius + 8}
              startAngle={startAngle} endAngle={endAngle} fill={fill}/>
      <Sector cx={cx} cy={cy} innerRadius={outerRadius + 6} outerRadius={outerRadius + 8}
              startAngle={startAngle} endAngle={endAngle} fill="rgba(255,255,255,0.25)"/>
    </g>
  );
}

function CategorySplitDonut({ data }) {
  const [wrapRef, sz] = useVisibleSize();
  const ready = sz.w > 0 && sz.visible;
  const [active, setActive] = React.useState(null);
  const series = (data || []).map(d => ({ name: d.name || d.category, value: Number(d.value ?? d.qty) || 0 }));

  // Canvas fallback if Recharts unavailable
  React.useEffect(()=>{
    if (HAS_R) return;
    const raw = series.map(s => ({ category: s.name, qty: s.value }));
    const t = setTimeout(()=> { renderPie(raw); }, 0);
    return () => clearTimeout(t);
  }, [series]);

  if (!HAS_R) {
    return (
      <div ref={wrapRef} className="relative" style={{ height: 380 }}>
        <canvas id="pieCanvas" width="640" height="360" className="w-full"></canvas>
      </div>
    );
  }

  return (
    <div ref={wrapRef} className="relative" style={{ height: 320 }}>
      {ready && (
        <ResponsiveContainer width="100%" height="100%">
          <PieChart>
            <defs>
              <filter id="ds1" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="6" stdDeviation="4" floodColor="#000" floodOpacity="0.25" />
              </filter>
            </defs>
            <Pie
              data={series}
              dataKey="value"
              nameKey="name"
              cx="50%"
              cy="50%"
              startAngle={90}      // 12 o'clock
              endAngle={-270}      // clockwise
              innerRadius={Math.floor(Math.max(120, Math.min(Math.floor(Math.min(sz.w, sz.h || 380) * 0.42), 200)) * 0.62)}
              outerRadius={Math.max(120, Math.min(Math.floor(Math.min(sz.w, sz.h || 380) * 0.42), 200))}
              paddingAngle={2}
              stroke="#fff"
              strokeWidth={2}
              isAnimationActive
              label={false}
              labelLine={false}
              activeIndex={active}
              onMouseEnter={(_, i) => setActive(i)}
              onMouseLeave={() => setActive(null)}
              activeShape={renderActiveShape3D}
            >
              {series.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
            </Pie>
            <Tooltip contentStyle={{ borderRadius: 12, borderColor: "#e5e7eb" }} />
          </PieChart>
        </ResponsiveContainer>
      )}
    </div>
  );
}


function StableLine({ data }) {
  const [ref, sz] = useVisibleSize();
  const ready = sz.w > 0 && sz.visible;

  // normalize for either backend or legacy shape
  const series = (data || []).map(d => ({
    week: d.week || d.d || "",
    invoices: Number(d.invoices ?? d.qty ?? 0),
    lines: Number(d.lines ?? 0)
  }));

  // ---- Fallback to canvas if Recharts is missing ----
  React.useEffect(()=>{
    if (HAS_R) return;
    const raw = series.map(s => ({ week: s.week, qty: s.invoices }));
    const t = setTimeout(()=> { renderWeekly(raw); }, 0);
    return () => clearTimeout(t);
  }, [series]);

  if (!HAS_R) {
    return (
      <div ref={ref} style={{ height: 280 }}>
        <canvas id="weeklyCanvas" width="640" height="280" className="w-full"></canvas>
      </div>
    );
  }

  // ---- Normal Recharts line chart ----
  return (
    <div ref={ref} style={{ height: 280 }}>
      {ready && (
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={series}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="week" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="invoices" stroke="#7C3AED" strokeWidth={2} dot={false} />
            <Line type="monotone" dataKey="lines" stroke="#10B981" strokeWidth={2} dot={false} />
          </LineChart>
        </ResponsiveContainer>
      )}
    </div>
  );
}

// ---- Pretty category labels + ticks for bar chart ----
const nf0 = (n) => new Intl.NumberFormat().format(Math.round(Number(n || 0)));

function fixCategoryLabel(raw = "") {
  let s = String(raw || "").trim();
  // clean stray comma fragments and dangling ampersands, fix common OCR typos
  s = s.replace(/,\s*[A-Za-z]?\s*$/, "");
  s = s.replace(/\s*&\s*$/, "");
  s = s.replace(/\bFixtur\b/i, "Fixture");
  s = s.replace(/\s{2,}/g, " ").trim();
  return s || "Uncategorized";
}

// 2-line tick for long categories
function TickTwoLine({ x, y, payload }) {
  const label = fixCategoryLabel(payload?.value);
  const max = 12; // wrap point
  const parts =
    label.length <= max ? [label] :
    [label.slice(0, max).trim(), label.slice(max).trim()];
  return (
    <text x={x} y={y + 12} textAnchor="middle" fill="#6b7280" fontSize={12}>
      <tspan x={x} dy="0">{parts[0]}</tspan>
      {parts[1] ? <tspan x={x} dy="14">{parts[1]}</tspan> : null}
    </text>
  );
}

// small horizontal red tick at the reorder level for each bar
const ReorderMarker = (props) => {
  const { x, y, width } = props;
  if (!isFinite(x) || !isFinite(y) || !isFinite(width)) return null;
  const pad = width * 0.2;
  return (
    <g>
      <line
        x1={x + pad}
        x2={x + width - pad}
        y1={y}
        y2={y}
        stroke="#ef4444"
        strokeWidth={3}
        strokeLinecap="round"
        opacity={0.9}
      />
    </g>
  );
};

// tooltip for the bar chart
const CatBarTip = ({ active, payload, label }) => {
  if (!active || !payload || !payload.length) return null;
  const d = payload[0].payload;
  const stock = Number(d.stock || 0);
  const reorder = Number(d.reorder || 0);
  const delta = stock - reorder;
  const status = delta >= 0 ? "Above" : "Below";
  return (
    <div style={{
      background: "#111827", color: "#fff", padding: "8px 10px",
      fontSize: 12, borderRadius: 8, boxShadow: "0 6px 22px rgba(0,0,0,.25)"
    }}>
      <div style={{ fontWeight: 600, marginBottom: 6 }}>{fixCategoryLabel(label)}</div>
      <div>Stock: <b>{nf0(stock)}</b></div>
      <div>Reorder: <b>{nf0(reorder)}</b></div>
      <div>Δ vs Reorder: <b>{nf0(delta)}</b> ({status})</div>
    </div>
  );
};

function CategoryStockBar({ data = [] }) {
  const [ref, sz] = useVisibleSize();
  const ready = sz.w > 0 && sz.visible;

  // ==== Recharts path ======================================================
  if (HAS_R) {
    const gid = "gradStock" + Math.random().toString(36).slice(2, 7);
    const [activeIdx, setActiveIdx] = React.useState(null);

    // normalized + pretty labels for display only
    const rows = (data || []).map(d => ({
      ...d,
      category: fixCategoryLabel(d.category),
    }));

    return (
      <div ref={ref} style={{ height: 320 }}>
        {ready && (
          <ResponsiveContainer width="100%" height="100%">
            <ComposedChart data={rows} onMouseLeave={() => setActiveIdx(null)}>
              <defs>
                <linearGradient id={gid} x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stopColor="#7C3AED" stopOpacity="0.9" />
                  <stop offset="100%" stopColor="#7C3AED" stopOpacity="0.25" />
                </linearGradient>
              </defs>

              <CartesianGrid stroke="#e5e7eb" vertical={false} />
              <XAxis dataKey="category" tick={<TickTwoLine />} height={42} tickMargin={6} interval={0} />
              <YAxis tick={{ fill: "#6b7280", fontSize: 12 }} axisLine={false} tickLine={false} allowDecimals={false} />
              <Tooltip content={<CatBarTip />} cursor={{ fill: "rgba(124,58,237,0.08)" }} />
              {/* prettier legend names */}
              {/* Bars with hover highlight */}
              <Bar
                dataKey="stock"
                name="Stock"
                fill={`url(#${gid})`}
                radius={[16, 16, 0, 0]}
                barSize={42}
                onMouseEnter={(_, i) => setActiveIdx(i)}
              >
                {rows.map((_, i) => (
                  <Cell
                    key={i}
                    stroke={i === activeIdx ? "rgba(124,58,237,.95)" : "transparent"}
                    strokeWidth={i === activeIdx ? 2 : 0}
                    fillOpacity={activeIdx == null ? 1 : (i === activeIdx ? 1 : 0.6)}
                  />
                ))}
              </Bar>

              {/* Per-bar red reorder tick (not a full line across) */}
              <Bar dataKey="reorder" isAnimationActive={false} shape={<ReorderMarker />} />
            </ComposedChart>
          </ResponsiveContainer>
        )}
      </div>
    );
  }

  // ==== Canvas fallback (when Recharts CDN is blocked) =====================
  React.useEffect(() => {
    const el = document.getElementById("catbarCanvas");
    if (!el) return;

    const tip = document.getElementById("chartTip");
    const ctx = el.getContext("2d");

    // size to CSS box + DPR
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = el.getBoundingClientRect();
    const W = el.width = Math.round(rect.width * dpr);
    const H = el.height = Math.round(280 * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, rect.width, 280);

    // normalize data & axis
    const rows = (data || []).map(d => ({
      category: fixCategoryLabel(d.category),
      stock: Number(d.stock || 0),
      reorder: Number(d.reorder || 0),
    }));
    const padL = 48, padR = 12, padT = 16, padB = 40;
    const maxY = Math.max(10, ...rows.map(r => Math.max(r.stock, r.reorder)));
    const band = (rect.width - padL - padR) / Math.max(1, rows.length);
    const barW = Math.max(18, band * 0.6);

    // axes
    ctx.strokeStyle = "#cbd5e1";
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, 280 - padB);
    ctx.lineTo(rect.width - padR, 280 - padB);
    ctx.stroke();

    // helpers
    const yOf = (v) => 280 - padB - ((280 - padB - padT) * (v / maxY));
    const bars = [];

    // draw bars + red reorder tick
    rows.forEach((r, i) => {
      const x = padL + i * band + (band - barW) / 2;
      const yS = yOf(r.stock), yR = yOf(r.reorder);
      const grad = ctx.createLinearGradient(0, yS, 0, 280 - padB);
      grad.addColorStop(0, "#7C3AED");
      grad.addColorStop(1, "#C4B5FD");
      ctx.fillStyle = grad;
(function () {
  const r = Math.min(12, barW / 2);
  const yB = 280 - padB, yT = yS, xL = x, xR = x + barW;
  ctx.beginPath();
  ctx.moveTo(xL, yB);
  ctx.lineTo(xL, yT + r);
  ctx.quadraticCurveTo(xL, yT, xL + r, yT);
  ctx.lineTo(xR - r, yT);
  ctx.quadraticCurveTo(xR, yT, xR, yT + r);
  ctx.lineTo(xR, yB);
  ctx.closePath();
  ctx.fill();
})();


      ctx.strokeStyle = "#ef4444";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(x + barW * 0.2, yR);
      ctx.lineTo(x + barW * 0.8, yR);
      ctx.stroke();

      bars.push({ x, w: barW, yS, yR, row: r });
    });

    // x labels (wrap to 2 lines)
    ctx.fillStyle = "#475569";
    ctx.font = "12px system-ui";
    rows.forEach((r, i) => {
      const x = padL + i * band + (band - barW) / 2 + barW / 2;
      const label = fixCategoryLabel(r.category);
      const max = 12;
      const line1 = label.slice(0, max).trim();
      const line2 = label.length > max ? label.slice(max).trim() : "";
      ctx.textAlign = "center";
      ctx.fillText(line1, x, 280 - padB + 14);
      if (line2) ctx.fillText(line2, x, 280 - padB + 28);
    });

    // hover interactions
    el.onmousemove = (evt) => {
      const r2 = el.getBoundingClientRect();
      const mx = evt.clientX - r2.left;
      const my = evt.clientY - r2.top;

      // find hit bar
      let hit = null;
      for (const b of bars) {
        if (mx >= b.x && mx <= b.x + b.w && my >= b.yS && my <= 280 - padB) { hit = b; break; }
      }

      // redraw base (simple highlight outline when hovering)
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, rect.width, 280);
      // (rebuild quickly)
      rows.forEach((r, i) => {
        const x = padL + i * band + (band - barW) / 2;
        const yS = yOf(r.stock), yR = yOf(r.reorder);
        const grad = ctx.createLinearGradient(0, yS, 0, 280 - padB);
        grad.addColorStop(0, "#7C3AED");
        grad.addColorStop(1, "#C4B5FD");
        ctx.fillStyle = grad;
ctx.globalAlpha = hit && fixCategoryLabel(r.category) !== hit.row.category ? 0.65 : 1;
(function () {
  const rTop = Math.min(12, barW / 2);
  const yB = 280 - padB, yT = yS, xL = x, xR = x + barW;
  ctx.beginPath();
  ctx.moveTo(xL, yB);
  ctx.lineTo(xL, yT + rTop);
  ctx.quadraticCurveTo(xL, yT, xL + rTop, yT);
  ctx.lineTo(xR - rTop, yT);
  ctx.quadraticCurveTo(xR, yT, xR, yT + rTop);
  ctx.lineTo(xR, yB);
  ctx.closePath();
  ctx.fill();
})();
ctx.globalAlpha = 1;

        ctx.strokeStyle = "#ef4444";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(x + barW * 0.2, yR);
        ctx.lineTo(x + barW * 0.8, yR);
        ctx.stroke();
      });
      // axes again
      ctx.strokeStyle = "#cbd5e1";
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, 280 - padB);
      ctx.lineTo(rect.width - padR, 280 - padB);
      ctx.stroke();

      // labels again
      ctx.fillStyle = "#475569";
      ctx.font = "12px system-ui";
      rows.forEach((r, i) => {
        const x = padL + i * band + (band - barW) / 2 + barW / 2;
        const label = fixCategoryLabel(r.category);
        const max = 12;
        const line1 = label.slice(0, max).trim();
        const line2 = label.length > max ? label.slice(max).trim() : "";
        ctx.textAlign = "center";
        ctx.fillText(line1, x, 280 - padB + 14);
        if (line2) ctx.fillText(line2, x, 280 - padB + 28);
      });

      if (!hit) { tip.style.display = "none"; el.style.cursor = "default"; return; }
      tip.textContent = `${hit.row.category} — ${nf0(hit.row.stock)} (ROP ${nf0(hit.row.reorder)})`;
      tip.style.left = `${evt.clientX}px`;
      tip.style.top = `${evt.clientY}px`;
      tip.style.display = "block";
      el.style.cursor = "pointer";
    };
    el.onmouseleave = () => { tip.style.display = "none"; el.style.cursor = "default"; };
  }, [data]);

  return (
    <div ref={ref} style={{ height: 320 }}>
      <canvas id="catbarCanvas" className="w-full" height="280"></canvas>
    </div>
  );
}



      function CategoryHSN({bills,loading}){
  // Build one row per category using HSN_GROUPS and counts from your invoices
  const rows = React.useMemo(()=>{
    // normalize bills to the shape buildCategoryAggregates expects
    const normalized = (bills || []).map(b => mapServerBill(b));
    const { pieData } = buildCategoryAggregates(normalized);
    // stitch the HSN list from your config + match counts from pieData
    return Object.entries(HSN_GROUPS).map(([category, hsns])=>{
      const found = pieData.find(d => d.category === category);
      return { category, hsn: hsns.join(", "), count: Math.round(found?.qty || 0) };
    });
  },[bills]);

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full text-left text-sm">
        <thead className="border-b border-slate-200 bg-slate-50 text-xs uppercase text-slate-500">
          <tr>
            <th className="px-4 py-3">Category</th>
            <th className="px-4 py-3">HSN</th>
            <th className="px-4 py-3"># Items</th>
          </tr>
        </thead>
        <tbody>
          {loading && <tr><td colSpan="3" className="px-4 py-10 text-center text-slate-500">Loading…</td></tr>}
          {!loading && rows.map((row,i)=>(
            <tr key={i} className="border-b border-slate-100 hover:bg-slate-50">
              <td className="px-4 py-3 font-medium text-slate-800">
  <span className="inline-flex items-center gap-2">
    <span className="text-lg leading-none">{iconForCategory(row.category)}</span>
    <span>{row.category}</span>
  </span>
</td>

              <td className="px-4 py-3">{row.hsn || "—"}</td>
              <td className="px-4 py-3">{row.count}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
      function StockTable({products,loading}){
        return (
          <div className="overflow-x-auto">
            <table className="min-w-full text-left text-sm">
              <thead className="border-b border-slate-200 bg-slate-50 text-xs uppercase text-slate-500">
                <tr>
                  <th className="px-4 py-3">Name</th>
                  <th className="px-4 py-3">Category</th>
                  <th className="px-4 py-3">HSN</th>
                  <th className="px-4 py-3">Price</th>
                  <th className="px-4 py-3">Stock Qty</th>
                  <th className="px-4 py-3">Reorder</th>

                </tr>
              </thead>
              <tbody>
                {loading && <tr><td colSpan="6" className="px-4 py-10 text-center text-slate-500">Loading…</td></tr>}
                {!loading && products.map((p,i)=>(
                  <tr key={i} className="border-b border-slate-100 hover:bg-slate-50">
                    <td className="px-4 py-3">{p.name || p.product_name || "—"}</td>
                    <td className="px-4 py-3">{p.category || "—"}</td>
                    <td className="px-4 py-3">{p.hsn || p.HSN || "—"}</td>
                    <td className="px-4 py-3">{fmtINR(p.price)}</td>
                    <td className="px-4 py-3">{p.stock_qty ?? p.qty ?? "0"}</td>
                    <td className="px-4 py-3">{p.reorder_point ?? "—"}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      // kept for completeness (not used by expand-in-table)
      function BillViewer({open, loading, bill, onClose}) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div className="max-h-[90vh] w-[960px] overflow-auto rounded-2xl bg-white shadow-xl">
              <div className="sticky top-0 flex items-center justify-between border-b border-slate-200 bg-white px-4 py-3">
                <div className="font-semibold">Bill Details</div>
                <button onClick={onClose} className="rounded border border-slate-200 px-2 py-1 text-sm">Close</button>
              </div>

              <div className="p-4">
                {loading && <div className="text-slate-500 text-sm">Loading…</div>}
                {!loading && bill && (
                  <>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="rounded-xl border border-slate-200 p-3">
                        <div className="text-sm font-semibold mb-2">Header</div>
                        <dl className="text-sm grid grid-cols-3 gap-x-3 gap-y-1">
                          <dt className="text-slate-500">Bill #</dt><dd className="col-span-2">{bill.bill_no || "—"}</dd>
                          <dt className="text-slate-500">Date</dt><dd className="col-span-2">{fmtDate(bill.bill_date)}</dd>
                          <dt className="text-slate-500">Vendor</dt><dd className="col-span-2">{bill.party_name || "—"}</dd>
                          <dt className="text-slate-500">GST Number</dt><dd className="col-span-2">{bill.gstin || "—"}</dd>
                          <dt className="text-slate-500">Total</dt><dd className="col-span-2">{fmtINR(bill.pre_total ?? bill.total)}</dd>
                        </dl>
                      </div>
                    </div>

                    <div className="mt-4 rounded-xl border border-slate-200">
                      <table className="min-w-full text-sm">
                        <thead className="bg-slate-50 text-slate-500">
                          <tr>
                            <th className="px-3 py-2 text-left">#</th>
                            <th className="px-3 py-2 text-left">Description</th>
                            <th className="px-3 py-2 text-left">HSN</th>
                            <th className="px-3 py-2 text-left">UOM</th>
                            <th className="px-3 py-2 text-right">Qty</th>
                            <th className="px-3 py-2 text-right">Rate</th>
                            <th className="px-3 py-2 text-right">Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          {(bill.lines || []).map((ln, i) => (
                            <tr key={i} className="border-t">
                              <td className="px-3 py-2">{ln.idx || i+1}</td>
                              <td className="px-3 py-2">{ln.description}</td>
                              <td className="px-3 py-2">{ln.hsn}</td>
                              <td className="px-3 py-2">{ln.uom}</td>
                              <td className="px-3 py-2 text-right">{ln.qty}</td>
                              <td className="px-3 py-2 text-right">{fmtINR(ln.rate)}</td>
                              <td className="px-3 py-2 text-right">{fmtINR(ln.amount)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<AuthGate />);
    </script>
    <div id="chartTip" class="chart-tip"></div>

  </body>
</html>